const e=e=>"function"==typeof e,r=(r,t="")=>{if(!e(r))throw new TypeError(`${t} Expecting function arg`.trim())},t=r=>e(r.subscribe),n=(t=void 0,n=null)=>{const s=r=>e(n?.persist)&&n.persist(r);let i=(()=>{const e=new Map,r=r=>(e.has(r)||e.set(r,new Set),e.get(r)),t=(e,t)=>{if("function"!=typeof t)throw new TypeError("Expecting callback function as second argument");return r(e).add(t),()=>r(e).delete(t)};return{publish:(e,t={})=>{r(e).forEach((e=>e(t)))},subscribe:t,subscribeOnce:(e,r)=>{const n=t(e,(e=>{r(e),n()}));return n},unsubscribeAll:r=>e.delete(r)}})(),c=t;s(c);const o=()=>c,u=e=>{c!==e&&(c=e,s(c),i.publish("change",c))};return{set:u,get:o,update:e=>{r(e,"[update]"),u(e(o()))},subscribe:e=>(r(e,"[subscribe]"),e(c),i.subscribe("change",e))}},s=e=>"object"==typeof e&&!Array.isArray(e)&&null!==e,i=(i,c=[],o=!1)=>{const u=e=>{if(!Array.isArray(e)||!e.every(s))throw new TypeError("Expecting array of initial item objects");return e};if(!Array.isArray(c)||!c.every((e=>!isNaN(e)&&void 0!==i[e])))throw new TypeError("Expecting array of initial selected indexes");const a=n(u(i)),p=n(c),b=e=>[...new Set(e)],f=((s,i,c=null)=>{const o=r=>e(c?.persist)&&c.persist(r),u=n(c?.initialValue),a=[];if(s.forEach((e=>{if(!t(e))throw new TypeError("Expecting array of StoreLike objects");e.subscribe((e=>a.push(e)))()})),!e(i))throw new TypeError("Expecting second argument to be the derivative function");if(!i.length||i.length>2)throw new TypeError("Expecting the derivative function to have exactly 1 or 2 arguments");let p=0,b=[];return{get:u.get,subscribe:e=>{r(e,"[derived.subscribe]"),p++||s.forEach(((e,r)=>{b.push(e.subscribe((e=>{a[r]=e,1===i.length?(u.set(i(a)),o(u.get())):i(a,(e=>{u.set(e),o(u.get())}))})))}));const t=u.subscribe(e);return()=>{--p||(b.forEach((e=>e())),b=[]),t()}}}})([a,p],(([e,r])=>({items:e,selected:r,selection:r.map((r=>e[r]))}))),l=e=>{if("number"!=typeof e)throw new TypeError("Expecting numeric index");const r=a.get();return r.length&&void 0!==r[e]?[e]:[]},d=(e,r)=>{if(!e.length)return r?p.set([]):void 0;if(!o)return((e,r)=>{const t=l(e);p.update((e=>!o||r?t:b([...e,...t])))})(e[e.length-1],r);const t=e.reduce(((e,r)=>[...e,...l(r)]),[]);p.update((e=>b(r?t:[...e,...t])))},g={subscribe:f.subscribe,get:f.get,select:(e,r=!0)=>{let t=Array.isArray(e)?e:[e];r&&p.set([]);let n=[];return t.forEach((e=>{"number"!=typeof e&&(e=a.get().findIndex((r=>r===e))),e>=0&&n.push(e)})),d(n,!1),g},unselect:e=>{if(void 0===e)return p.set([]),g;const r=p.get();if(!r.length)return g;let t=Array.isArray(e)?e:[e],n=r.reduce(((e,r)=>({...e,[r]:!0})),{});return t.forEach((e=>{"number"!=typeof e&&(e=a.get().findIndex((r=>r===e))),delete n[e]})),d(Object.keys(n).map((e=>parseInt(e))),!0),g},findIndexBy:(e,r)=>((e,r,t)=>t.findIndex((t=>t&&void 0!==t[e]&&t[e]===r)))(e,r,a.get()),reset:(e=[])=>(p.set([]),a.set(u(e||[])),g)};return g};export{i as createSelectionStore};
